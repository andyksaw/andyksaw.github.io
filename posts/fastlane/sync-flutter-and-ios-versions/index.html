<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Force-sync your Flutter and iOS versions | andysaw</title><meta name=keywords content="ios,fastlane,flutter"><meta name=description content="While iOS app distribution can already be a challenge on its own, Flutter is a black box wrapping around that to add an extra level of undocumented pain.
Just like regular iOS development, we can apply Fastlane to automate our app distribution pipeline, but there&rsquo;s plenty of unexpected hiccups that happen along the way. Flutter being a cross-platform development solution however, it tries to abstract away differences in the platforms at the cost of some black magic."><meta name=author content><link rel=canonical href=https://andyksaw.github.io/posts/fastlane/sync-flutter-and-ios-versions/><link crossorigin=anonymous href=/assets/css/stylesheet.min.34f610da9fa2cd806ab9ff3f025f84f8f50c190cfbe3eb63b50b7d092bd7afdf.css integrity="sha256-NPYQ2p+izYBquf8/Al+E+PUMGQz74+tjtQt9CSvXr98=" rel="preload stylesheet" as=style><link rel=icon href=https://andyksaw.github.io/favicon.ico><link rel=apple-touch-icon href=https://andyksaw.github.io/apple-touch-icon.png><meta name=twitter:title content="Force-sync your Flutter and iOS versions | andysaw"><meta name=twitter:description content="While iOS app distribution can already be a challenge on its own, Flutter is a black box wrapping around that to add an extra level of undocumented pain.
Just like regular iOS development, we can apply Fastlane to automate our app distribution pipeline, but there&rsquo;s plenty of unexpected hiccups that happen along the way. Flutter being a cross-platform development solution however, it tries to abstract away differences in the platforms at the cost of some black magic."><meta property="og:title" content="Force-sync your Flutter and iOS versions | andysaw"><meta property="og:description" content="While iOS app distribution can already be a challenge on its own, Flutter is a black box wrapping around that to add an extra level of undocumented pain.
Just like regular iOS development, we can apply Fastlane to automate our app distribution pipeline, but there&rsquo;s plenty of unexpected hiccups that happen along the way. Flutter being a cross-platform development solution however, it tries to abstract away differences in the platforms at the cost of some black magic."><meta property="og:type" content="article"><meta property="og:url" content="https://andyksaw.github.io/posts/fastlane/sync-flutter-and-ios-versions/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-10T11:23:00+09:00"><meta property="article:modified_time" content="2023-01-10T11:23:00+09:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andyksaw.github.io/posts/"},{"@type":"ListItem","position":3,"name":"","item":"https://andyksaw.github.io/posts/fastlane/"},{"@type":"ListItem","position":4,"name":"Force-sync your Flutter and iOS versions","item":"https://andyksaw.github.io/posts/fastlane/sync-flutter-and-ios-versions/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Force-sync your Flutter and iOS versions | andysaw","name":"Force-sync your Flutter and iOS versions","description":"While iOS app distribution can already be a challenge on its own, Flutter is a black box wrapping around that to add an extra level of undocumented pain.\nJust like regular iOS development, we can apply Fastlane to automate our app distribution pipeline, but there\u0026rsquo;s plenty of unexpected hiccups that happen along the way. Flutter being a cross-platform development solution however, it tries to abstract away differences in the platforms at the cost of some black magic.","keywords":["ios","fastlane","flutter"],"wordCount":"1063","inLanguage":"en","datePublished":"2023-01-10T11:23:00+09:00","dateModified":"2023-01-10T11:23:00+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://andyksaw.github.io/posts/fastlane/sync-flutter-and-ios-versions/"},"publisher":{"@type":"Organization","name":"andysaw","logo":{"@type":"ImageObject","url":"https://andyksaw.github.io/favicon.ico"}}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-2747125-3"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-2747125-3")</script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary-bg:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list-page{background:var(--theme)}.list-page:not(.dark)::-webkit-scrollbar-track{background:0 0}.list-page:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript></head><body class="type-posts kind-page layout-" id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="light",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><header class=header><nav class=nav><div class=logo><a href=https://andyksaw.github.io accesskey=h title="andysaw (Alt + H)">andysaw</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andyksaw.github.io/categories/ title=categories>categories</a></li><li><a href=https://andyksaw.github.io/tags/ title=tags>tags</a></li><li><a href=https://andyksaw.github.io/search/ title="search (Alt + /)" data-no-instant accesskey=/>search</a></li><li><a href=https://andyksaw.github.io/archives/ title=archive>archive</a></li></ul></nav></header><main class="main post"><article class=post-single><header class=post-header><h1 class=post-title>Force-sync your Flutter and iOS versions</h1><div class=post-meta><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>January 10, 2023</span></span><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon" style="user-select:text"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z" style="user-select:text"/><line x1="7" y1="7" x2="7" y2="7" style="user-select:text"/></svg>
<span class=post-tags><a href=https://andyksaw.github.io/tags/ios/>ios</a><a href=https://andyksaw.github.io/tags/fastlane/>fastlane</a><a href=https://andyksaw.github.io/tags/flutter/>flutter</a></span></span><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>5 min</span></span></div></header><div class="toc side right"><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><ul><li><a href=#the-source-of-truth aria-label="The Source of Truth">The Source of Truth</a></li><li><a href=#how-does-ios-get-the-flutter-version aria-label="How does iOS get the Flutter version?">How does iOS get the Flutter version?</a></li><li><a href=#so-whats-the-problem aria-label="So what&amp;rsquo;s the problem?">So what&rsquo;s the problem?</a></li></ul><li><a href=#the-solution aria-label="The Solution">The Solution</a><ul><li><a href=#custom-fastlane-action aria-label="Custom Fastlane Action">Custom Fastlane Action</a></li></ul></li></ul></div></details></div><div class=post-content><p>While iOS app distribution can already be a challenge on its own, Flutter is a black box wrapping around that to add an extra level of <em>undocumented pain</em>.</p><p>Just like regular iOS development, we can apply Fastlane to automate our app distribution pipeline, but there&rsquo;s plenty of unexpected hiccups that happen along the way. Flutter being a cross-platform development solution however, it tries to abstract away differences in the platforms at the cost of some black magic.</p><p>One particularly annoying issue I faced is that the version I defined for my Flutter app was often different to what the iOS app claimed it to be.</p><h2 id=the-source-of-truth>The Source of Truth<a hidden class=anchor aria-hidden=true href=#the-source-of-truth>¶</a></h2><p>As a quick recap on how Flutter&rsquo;s versioning works, we define our Flutter app&rsquo;s version in the <code>pubspec.yaml</code> file.</p><p>It expects <a href=https://semver.org/>semantic versioning</a>, and a build number.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dart data-lang=dart><span class=line><span class=cl><span class=nl>version:</span> <span class=m>1.2</span><span class=p>.</span><span class=m>3</span><span class=o>+</span><span class=m>4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Major = 1
</span></span></span><span class=line><span class=cl><span class=c1>// Minor = 2
</span></span></span><span class=line><span class=cl><span class=c1>// Patch = 3
</span></span></span><span class=line><span class=cl><span class=c1>// Build = 4
</span></span></span></code></pre></td></tr></table></div></div><p>The value defined here is automatically used by the iOS and Android app built for us by Flutter.</p><p>For iOS, this becomes like so:</p><table><thead><tr><th><code>Info.plist</code> Raw Key</th><th>Description</th><th>Value Based on Above Example</th></tr></thead><tbody><tr><td><code>CFBundleShortVersionString</code></td><td>Version string</td><td><code>1.2.3</code></td></tr><tr><td><code>CFBundleVersion</code></td><td>Build number</td><td><code>4</code></td></tr></tbody></table><ul><li>The version string (<code>major</code>.<code>minor</code>.<code>patch</code>) is the public-facing version. People can see this on the App Store.</li><li>The build number on the other hand is mainly for distribution platforms to differentiate between multiple copies of your app that have the same version string.<ul><li>For example, it&rsquo;s very common in large teams to have a pipeline that automatically distributes your app to developers/internal testers whenever a commit is pushed to the main branch. In such a system, developers push many changes under the same version string before a new version is released. Each change automatically increments the build number so that the uploaded version is unique in the eyes of the distribution platform.</li><li>This is important to note because some distribution platforms like <a href=https://developer.apple.com/testflight/>TestFlight</a> will not allow you to upload your app if the version string & build number combination has already been uploaded for your app identifier.</li></ul></li></ul><p>In Flutter land, <code>pubspec.yaml</code> is our source of truth in the sense that each platform (iOS, Android) will receive the version defined in that file when building the app, as opposed to each platform defining the versions themselves and duplicating these values all over the place.</p><h2 id=how-does-ios-get-the-flutter-version>How does iOS get the Flutter version?<a hidden class=anchor aria-hidden=true href=#how-does-ios-get-the-flutter-version>¶</a></h2><p>Flutter generates two files for us in the <code>ios/Flutter</code> folder:</p><ol><li><code>flutter_export_environment.sh</code></li><li><code>Generated.xcconfig</code></li></ol><p>These are essentially a Key-Value map of build settings - two of which are of particular interest:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>// Generated.xcconfig
</span></span><span class=line><span class=cl><span class=nv>FLUTTER_BUILD_NAME</span><span class=o>=</span>1.2.3
</span></span><span class=line><span class=cl><span class=nv>FLUTTER_BUILD_VERSION</span><span class=o>=</span><span class=m>4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// flutter_export_environment.sh
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=s2>&#34;FLUTTER_BUILD_NAME=1.2.3&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=s2>&#34;FLUTTER_BUILD_VERSION=4&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>Flutter takes the version in <code>pubspec.yaml</code> and generates these two files with the version string (amongst other things).</p><p><code>Generated.xcconfig</code> is an <em>Xcode build configuration file</em> that is read during compile-time when building the iOS app. These build settings are loaded into the project during compilation as if they had been declared in the <code>xcodeproj</code>.</p><blockquote><p>Check out <a href=https://nshipster.com/xcconfig/>here</a> if you&rsquo;re interested to see more on what <code>xcconfig</code> files can do</p></blockquote><p>As mentioned before, the version string is read from the <code>CFBundleShortVersionString</code> and <code>CFBundleVersion</code> keys inside <code>Info.plist</code> and bundled with the app. Unlike a conventional iOS app however, these point to the value received from <code>Generated.xcconfig</code> rather than a hardcoded value.</p><p>Quite a lot of misdirection, but at least it gets the job done.</p><p>&mldr; usually.</p><h2 id=so-whats-the-problem>So what&rsquo;s the problem?<a hidden class=anchor aria-hidden=true href=#so-whats-the-problem>¶</a></h2><p>There&rsquo;s two ways to compile/run the iOS app:</p><ol><li>Run the <code>flutter build</code> command in CLI</li><li>OR open Xcode and compile the app</li></ol><p>Regardless of which way you choose, the versions will still be pulled out of <code>Generated.xcconfig</code> at compile-time.</p><p>Great! &mldr; but actually it turns out that the two files (<code>flutter_export_environment.sh</code> and <code>Generated.xcconfig</code>) are <strong>only generated when using the <code>flutter build</code> command</strong>. And therein lies the problem with the Flutter black box.</p><p>In other words, if you change the version in <code>pubspec.yaml</code> and then compile the app with Xcode, the bundled version will still be the old version because this process is not managed by Flutter.</p><p>It&rsquo;s a fairly common scenario and I&rsquo;m very surprised there isn&rsquo;t any ruckus about it. In the past I&rsquo;ve accidentally pushed an app labelled with the wrong version to TestFlight before due to this issue, and there&rsquo;s no way to delete it other than to &ldquo;expire&rdquo; the build. Annoying.</p><h1 id=the-solution>The Solution<a hidden class=anchor aria-hidden=true href=#the-solution>¶</a></h1><p>I must preface this by saying this is a hacky workaround. We&rsquo;re tampering with generated files, and that always bears the risk of breaking in a future update of Flutter. That being said, this solution works for me and the trade-off is worth the risk. YMMV.</p><p>Basically, we will want to overwrite the version values written in the two generated files (<code>flutter_export_environment.sh</code> and <code>Generated.xcconfig</code>) before compiling the iOS app.</p><p>There&rsquo;s many ways to achieve this: a bash script, a git hook, a run script (for your xcodeproj) and more. Since I&rsquo;m already using Fastlane to automate app distribution, I decided to write a <a href=https://docs.fastlane.tools/create-action/>custom Fastlane action</a>.</p><h2 id=custom-fastlane-action>Custom Fastlane Action<a hidden class=anchor aria-hidden=true href=#custom-fastlane-action>¶</a></h2><p>Create a new Fastlane action using the <code>fastlane new_action</code> command, and give it a name. For our intents and purposes, I named it <code>sync_ios_with_pubspec_version</code>.</p><p>Next we&rsquo;ll write a Ruby script to read the version from the <code>pubspec.yaml</code> file, and overwrite the values in the two generated files.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=nb>require</span> <span class=s1>&#39;yaml&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=nn>Fastlane</span>
</span></span><span class=line><span class=cl>  <span class=k>module</span> <span class=nn>Actions</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>SyncIosWithPubspecVersionAction</span> <span class=o>&lt;</span> <span class=no>Action</span>
</span></span><span class=line><span class=cl>      <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>run</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>yaml</span> <span class=o>=</span> <span class=no>YAML</span><span class=o>.</span><span class=n>load_file</span><span class=p>(</span><span class=s2>&#34;pubspec.yaml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>version</span> <span class=o>=</span> <span class=n>yaml</span><span class=o>[</span><span class=s2>&#34;version&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>matches</span> <span class=o>=</span> <span class=sr>/^(\d+)\.(\d+)\.(\d+)\+(\d+)$/</span><span class=o>.</span><span class=n>match</span><span class=p>(</span><span class=n>version</span><span class=p>)</span><span class=o>.</span><span class=n>captures</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>major</span> <span class=o>=</span> <span class=n>matches</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=n>minor</span> <span class=o>=</span> <span class=n>matches</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=n>patch</span> <span class=o>=</span> <span class=n>matches</span><span class=o>[</span><span class=mi>2</span><span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=n>build</span> <span class=o>=</span> <span class=n>matches</span><span class=o>[</span><span class=mi>3</span><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>pubspsec_version</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>#{</span><span class=n>major</span><span class=si>}</span><span class=s2>.</span><span class=si>#{</span><span class=n>minor</span><span class=si>}</span><span class=s2>.</span><span class=si>#{</span><span class=n>patch</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>[</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;ios/Flutter/flutter_export_environment.sh&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;ios/Flutter/Generated.xcconfig&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=n>file_name</span><span class=o>|</span>
</span></span><span class=line><span class=cl>          <span class=n>edited_data</span> <span class=o>=</span> <span class=no>File</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>file_name</span><span class=p>)</span> <span class=k>do</span> <span class=o>|</span><span class=n>f</span><span class=o>|</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span><span class=o>.</span><span class=n>read</span>
</span></span><span class=line><span class=cl>              <span class=o>.</span><span class=n>gsub</span><span class=p>(</span><span class=sr>/FLUTTER_BUILD_NAME=[\d\.]+/</span><span class=p>,</span> <span class=s2>&#34;FLUTTER_BUILD_NAME=</span><span class=si>#{</span><span class=n>pubspsec_version</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=o>.</span><span class=n>gsub</span><span class=p>(</span><span class=sr>/FLUTTER_BUILD_NUMBER=\d+/</span><span class=p>,</span> <span class=s2>&#34;FLUTTER_BUILD_NUMBER=</span><span class=si>#{</span><span class=n>build</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=k>end</span>
</span></span><span class=line><span class=cl>          <span class=no>IO</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>file_name</span><span class=p>,</span> <span class=n>edited_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>      <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>description</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Forces the iOS app&#39;s version to be overwritten with the value in pubspec.yaml&#34;</span>
</span></span><span class=line><span class=cl>      <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>is_supported?</span><span class=p>(</span><span class=n>platform</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>platform</span> <span class=o>==</span> <span class=ss>:ios</span>
</span></span><span class=line><span class=cl>      <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></td></tr></table></div></div><p>Finally, we just need to invoke our new custom action from any <code>Fastfile</code> lane that builds the app. This will ensure the version is always synced.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=hl><span class=lnt>2
</span></span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>lane</span> <span class=ss>:beta</span> <span class=k>do</span> <span class=o>|</span><span class=n>options</span><span class=o>|</span>
</span></span><span class="line hl"><span class=cl>    <span class=n>sync_ios_with_pubspec_version</span>
</span></span><span class=line><span class=cl>    <span class=n>build_app</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>upload_to_testflight</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></td></tr></table></div></div><p>Not exactly elegant, but at least the problem is solved for now.</p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://andyksaw.github.io>andysaw</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n=""=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script>
<script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>(function(){const a="1"=="1";if(!a)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const r=window.scrollListeners,t=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),n="active";let e=t[0];o(e).classList.add(n);const c=()=>{const s=[];for(const e of t)if(l(e)<5)s.push(e);else break;s.length>0?newActiveHeading=s[s.length-1]:newActiveHeading=t[0],e!=newActiveHeading&&(o(e).classList.remove(n),e=newActiveHeading,o(e).classList.add(n))};let s=null;const i=()=>{s!==null&&clearTimeout(s),s=setTimeout(c,50)};window.addEventListener("scroll",i,!1),r.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script></body></html>